# Rust移行計画

## 📊 プロジェクト概要

### 現状
- **言語**: TypeScript (Node.js 18+)
- **コード規模**: 7,167行（23ファイル）
- **テスト**: 19ファイル、367テスト、89%カバレッジ
- **依存関係**: 17個（runtime） + 11個（dev）
- **ビルド成果物**: 652KB
- **起動時間**: 約0.56秒

### 移行目標
- **言語**: Rust (Edition 2021)
- **起動時間**: 0.01-0.05秒（10-50倍高速化）
- **バイナリサイズ**: 3-5MB（シングルバイナリ）
- **メモリ使用量**: 大幅削減（Node.js runtime不要）
- **配布**: crates.io + Homebrew + cargo-binstall

---

## 📋 タスク分解

### Phase 0: 準備・調査（1-2週間）

#### 1. Rust CLIフレームワーク選定（2-3日）
- **優先度**: 高
- **見積**: 2-3日（楽観: 1.5日, 悲観: 4日）
- **依存**: なし
- **詳細**:
  - clap 4.x（主流、derive API）
  - structopt（clap v3時代の前身）
  - argh（軽量、Google製）
  - 現行commander.js機能との互換性確認
  - POC実装（簡易CLI）

#### 2. 依存関係マッピング（1-2日）
- **優先度**: 高
- **見積**: 1-2日
- **依存**: なし
- **詳細**:
  - npm依存17個のRust代替調査
    - chalk → colored / owo-colors
    - ora → indicatif
    - commander → clap
    - js-yaml → serde_yaml
    - zod → serde + validator
  - 機能差分の洗い出し
  - 自前実装が必要な機能の特定

#### 3. ビルド・配布戦略策定（1-2日）
- **優先度**: 高
- **見積**: 1-2日
- **依存**: タスク1
- **詳細**:
  - cargo-dist導入検討
  - クロスコンパイル設定（macOS/Linux/Windows）
  - GitHub Actions CI/CD設定
  - cargo-binstall対応
  - Homebrew Formula自動生成

---

### Phase 1: コアロジック移行（2-3週間）

#### 4. 型定義・データ構造移行（3-4日）
- **優先度**: 高
- **見積**: 3-4日
- **依存**: タスク2
- **詳細**:
  - src/core/interfaces.ts → Rust trait定義
  - PublishConfig → serde対応struct
  - エラー型設計（thiserror使用）
  - 型安全性の強化（borrow checker活用）

#### 5. プラグインシステム移行（4-5日）
- **優先度**: 高
- **見積**: 4-5日
- **依存**: タスク4
- **詳細**:
  - Plugin trait定義
  - NPMPlugin, CratesIOPlugin, PyPIPlugin, HomebrewPlugin
  - 動的プラグインローダー実装
  - プラグイン設定の統一化

#### 6. セキュリティ機能移行（3-4日）
- **優先度**: 高（セキュリティクリティカル）
- **見積**: 3-4日
- **依存**: タスク4
- **詳細**:
  - SecretsScanner（正規表現 + gitignore除外）
  - SecureTokenManager（環境変数管理）
  - SafeCommandExecutor（コマンドインジェクション対策）
  - メモリ安全性の追加保証（Rust borrow checker）

#### 7. コア機能移行（5-6日）
- **優先度**: 高
- **見積**: 5-6日
- **依存**: タスク4, 5, 6
- **詳細**:
  - PackagePublisher本体
  - BatchPublisher（並列処理 tokio活用）
  - PublishStateMachine（状態管理）
  - RetryManager（エクスポネンシャルバックオフ）

---

### Phase 2: 拡張機能移行（1-2週間）

#### 8. Hooks & Notifications（3-4日）
- **優先度**: 中
- **見積**: 3-4日
- **依存**: タスク7
- **詳細**:
  - HookExecutor（4フェーズフック）
  - SlackNotifier（webhook経由）
  - EmailNotifier（SMTP）
  - NotificationManager（通知統合）

#### 9. 分析・統計機能（2-3日）
- **優先度**: 中
- **見積**: 2-3日
- **依存**: タスク7
- **詳細**:
  - PublishAnalytics（統計収集）
  - レポート生成機能（JSON/Markdown）
  - 成功率・失敗率計算

#### 10. 設定管理（2-3日）
- **優先度**: 中
- **見積**: 2-3日
- **依存**: タスク4
- **詳細**:
  - ConfigLoader（YAML読み込み、serde_yaml）
  - 環境変数統合（dotenv対応）
  - 設定バリデーション（validator）

---

### Phase 3: CLI & テスト（2-3週間）

#### 11. CLI実装（3-4日）
- **優先度**: 高
- **見積**: 3-4日
- **依存**: タスク1, 7
- **詳細**:
  - clap定義（publish, check, stats, report）
  - サブコマンド実装
  - インタラクティブプロンプト（dialoguer）
  - カラー出力（colored）・プログレス表示（indicatif）

#### 12. テスト移行（7-10日）
- **優先度**: 高
- **見積**: 7-10日（楽観: 6日, 悲観: 14日）
- **依存**: タスク4-11
- **詳細**:
  - ユニットテスト367個の移植
  - モック実装（mockall使用）
  - テストヘルパー関数
  - カバレッジ目標: 85%以上

#### 13. E2Eテスト（2-3日）
- **優先度**: 中
- **見積**: 2-3日
- **依存**: タスク11, 12
- **詳細**:
  - 実際のレジストリ連携テスト
  - CI/CD統合テスト
  - エラーケーステスト

---

### Phase 4: ドキュメント・リリース（1週間）

#### 14. ドキュメント更新（2-3日）
- **優先度**: 高
- **見積**: 2-3日
- **依存**: タスク11
- **詳細**:
  - README.md, README.ja.md更新
  - Rust特有の設定ガイド
  - TypeScript版からの移行ガイド作成
  - API仕様書更新

#### 15. パッケージング（2-3日）
- **優先度**: 高
- **見積**: 2-3日
- **依存**: タスク3, 11
- **詳細**:
  - crates.io公開準備（Cargo.toml整備）
  - Homebrew Formula作成（cargo-dist）
  - GitHub Releases設定
  - バイナリ配布（Linux/macOS/Windows）

#### 16. 並行運用期間（1-2週間）
- **優先度**: 中
- **見積**: 1-2週間
- **依存**: タスク15
- **詳細**:
  - TypeScript版とRust版の並行提供
  - フィードバック収集
  - バグ修正・性能チューニング
  - マイグレーション完了判定

---

## 🔗 依存関係グラフ

```
Phase 0: [1] → [3]
         [2]

Phase 1: [2,3] → [4] → [5]
                  ↓     ↓
                 [6] → [7]

Phase 2: [7] → [8]
         [7] → [9]
         [4] → [10]

Phase 3: [1,7] → [11] → [13]
         [4-11] → [12] → [13]

Phase 4: [11] → [14]
         [3,11] → [15] → [16]
```

**クリティカルパス**: [1] → [3] → [4] → [7] → [11] → [12] → [15] → [16]

**並列実行可能**:
- Phase 0: タスク1 & タスク2（同時実行可能）
- Phase 1: タスク5 & タスク6（タスク4完了後）
- Phase 2: タスク8 & タスク9 & タスク10（タスク7完了後）

---

## ⏱️ 見積サマリー

### フェーズ別見積
- **Phase 0**: 4-7日（準備）
- **Phase 1**: 15-19日（コアロジック）
- **Phase 2**: 7-10日（拡張機能）
- **Phase 3**: 12-17日（CLI & テスト）
- **Phase 4**: 5-8日（ドキュメント・リリース）

### 総見積
- **楽観**: 43日（約6週間）
- **最頻**: 61日（約9週間）
- **悲観**: 86日（約12週間）
- **期待値（PERT）**: (43 + 4×61 + 86) / 6 ≈ **63日（約9週間）**

### 工数換算（1人フルタイム）
- **総工数**: 約320-430時間
- **週40時間**: 8-11週間
- **週20時間（半分リソース）**: 16-22週間

---

## 🛡️ リスク要素（初期特定）

### セキュリティリスク 🔒
1. **トークン管理の安全性**
   - TypeScript版の環境変数管理をRustでも維持
   - メモリ安全性向上（Rust borrow checker）

2. **コマンドインジェクション対策**
   - SafeCommandExecutor再実装時の検証

3. **シークレットスキャナー精度**
   - 正規表現パターンの移植ミスリスク

### パフォーマンスリスク ⚡
1. **起動時間目標達成**
   - 目標: 0.01-0.05秒（現行0.56秒の1/10以下）
   - リスク: 外部クレート依存で肥大化

2. **並列処理の複雑性**
   - tokio非同期ランタイムの学習コスト
   - デッドロック・競合状態のリスク

### 技術的リスク ⚙️
1. **依存関係の機能差分**
   - npm依存のRust代替が完全互換でない可能性
   - 自前実装の工数増大リスク

2. **テスト移植の複雑性**
   - 367テストの正確な移植
   - モック実装の難易度

3. **クロスプラットフォーム対応**
   - Windows/Linux/macOS各環境でのビルド検証
   - CI/CDパイプラインの複雑化

### 開発効率リスク 📊
1. **学習コスト**
   - Rust習得時間（特にborrow checker、lifetime）
   - 非同期プログラミング（tokio）

2. **工数見積の不確実性**
   - 初めてのRust大規模プロジェクト
   - 予期しない技術的障壁

3. **並行運用の負担**
   - TypeScript版とRust版の両方をメンテナンス
   - バグ修正の2倍コスト

### ビジネスリスク 💼
1. **ROI（投資対効果）**
   - 9週間の開発投資 vs 得られる利益
   - 現行TypeScript版で問題なし

2. **ユーザー影響**
   - 既存ユーザーの移行負担
   - 破壊的変更のリスク

3. **保守性リスク**
   - チームメンバーのRust習熟度
   - バスファクターリスク

---

## 📈 成功指標（KPI）

### パフォーマンス
- [ ] 起動時間: 0.05秒以下（目標: 0.01-0.03秒）
- [ ] メモリ使用量: 10MB以下
- [ ] バイナリサイズ: 5MB以下

### 品質
- [ ] テストカバレッジ: 85%以上
- [ ] 全367テストの移植完了
- [ ] セキュリティ監査: 0件のCritical Issue

### 配布
- [ ] crates.io公開
- [ ] Homebrew Formula提供
- [ ] Windows/Linux/macOS対応

### 互換性
- [ ] TypeScript版との機能完全互換
- [ ] 既存設定ファイルの互換性維持

---

## 🚨 中断・撤退基準

以下の条件で移行を中断・撤退を検討：

1. **スケジュール超過**: 期待値（63日）の1.5倍（約95日）超過
2. **品質未達**: テストカバレッジ70%未満
3. **パフォーマンス未達**: 起動時間0.1秒以上
4. **クリティカルバグ**: セキュリティ重大欠陥の発見
5. **技術的障壁**: 解決不能な依存関係問題

---

## 📌 代替案

### 案1: ハイブリッド戦略（推奨）
- **Phase 1のみ実施**: SecretsScanner等の性能クリティカルな部分のみRust化
- **N-API統合**: Rust製ネイティブモジュールとしてTypeScriptから呼び出し
- **工数**: 約2週間
- **リスク**: 低

### 案2: TypeScript継続（最推奨）
- **現状維持**: 品質改善・リファクタリングに注力
- **工数**: 0（追加投資なし）
- **リスク**: 極小

---

## 🎯 推奨アクション

**現時点での推奨: Rust移行を実施しない**

**理由**:
1. 現行TypeScript実装の品質が高い（89%カバレッジ、367テスト）
2. 致命的な問題が存在しない（起動時間0.56秒は許容範囲）
3. ROIが低い（9週間の投資 vs 起動時間0.5秒短縮のみ）
4. ハイブリッド戦略で十分（必要な部分のみRust化）

**今後の判断基準**:
- 起動時間がボトルネックとなる具体的ユースケースが発生
- 大規模プロジェクトでのスキャン性能問題が顕在化
- チーム全体のRust習熟度が十分に向上
- 3ヶ月の開発投資が正当化される明確なビジネス価値

---

## 📚 参考資料

### Rust CLIベストプラクティス
- [Rust CLI Book](https://rust-cli.github.io/book/)
- [clap documentation](https://docs.rs/clap/)
- [cargo-dist](https://opensource.axo.dev/cargo-dist/)

### TypeScript → Rust移行事例
- [ripgrep](https://github.com/BurntSushi/ripgrep) - grep代替
- [fd](https://github.com/sharkdp/fd) - find代替
- [bat](https://github.com/sharkdp/bat) - cat代替

### セキュリティ
- [Rust Security Advisory Database](https://rustsec.org/)
- [OWASP Rust Security Cheat Sheet](https://cheatsheetseries.owasp.org/)
